name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Run quality checks
      run: |
        Write-Host "Running quality checks..."
        mypy src/
        ruff check src/
        black --check src/
        pytest tests/ -q

    - name: Build EXE
      run: |
        Write-Host "Building EXE..."
        pyinstaller `
          --name=NetworkAdapterSwitcher `
          --onefile `
          --windowed `
          --clean `
          --add-data="src;src" `
          --hidden-import=tkinter `
          --hidden-import=tkinter.ttk `
          --hidden-import=tkinter.messagebox `
          --manifest=app.manifest `
          src\main.py

    - name: Verify build
      run: |
        if (Test-Path "dist\NetworkAdapterSwitcher.exe") {
          $size = (Get-Item "dist\NetworkAdapterSwitcher.exe").Length / 1MB
          Write-Host "âœ“ Build successful"
          Write-Host "  File: NetworkAdapterSwitcher.exe"
          Write-Host "  Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âœ— Build failed"
          exit 1
        }

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "dist\NetworkAdapterSwitcher.exe", "README.md", "BUILD.md" -DestinationPath "NetworkAdapterSwitcher-v${{ steps.get_version.outputs.VERSION }}-windows-x64.zip"

    - name: Generate release notes
      id: release_notes
      run: |
        $notes = @"
        ## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ„ãƒ¼ãƒ« v${{ steps.get_version.outputs.VERSION }}

        ### ðŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

        - **Windows 10/11 (64-bit)**: ``NetworkAdapterSwitcher-v${{ steps.get_version.outputs.VERSION }}-windows-x64.zip``

        ### ðŸš€ ä½¿ç”¨æ–¹æ³•

        1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
        2. ``NetworkAdapterSwitcher.exe`` ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã€
        3. GUIã§ã‚¤ãƒ¼ã‚µãƒãƒƒãƒˆâ‡”Wi-Fiã‚’åˆ‡ã‚Šæ›¿ãˆ

        ### âš ï¸ æ³¨æ„äº‹é …

        - Windows 10/11ãŒå¿…è¦ã§ã™
        - ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        - .NET Frameworkã‚„Pythonã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä¸è¦ã§ã™

        ### ðŸ“ å¤‰æ›´å±¥æ­´

        å¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

        ### ðŸ› å•é¡Œå ±å‘Š

        ãƒã‚°ã‚„æ”¹å–„è¦æœ›ã¯ [Issues](https://github.com/${{ github.repository }}/issues) ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
        "@
        
        $notes | Out-File -FilePath release_notes.md -Encoding utf8
        echo "RELEASE_NOTES_FILE=release_notes.md" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: v${{ steps.get_version.outputs.VERSION }}
        body_path: ${{ steps.release_notes.outputs.RELEASE_NOTES_FILE }}
        draft: false
        prerelease: false
        files: |
          NetworkAdapterSwitcher-v${{ steps.get_version.outputs.VERSION }}-windows-x64.zip
          dist/NetworkAdapterSwitcher.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-v${{ steps.get_version.outputs.VERSION }}
        path: |
          dist/NetworkAdapterSwitcher.exe
          NetworkAdapterSwitcher-v${{ steps.get_version.outputs.VERSION }}-windows-x64.zip
        retention-days: 90
